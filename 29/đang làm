CREATE PROCEDURE [Toiawase_Etc].[GetDataPG627007207] (
	@N__USER_NO AS INT
    ,@C__SESSION_ID AS NVARCHAR(100)
    ,@N__PROGRAM_CODE AS INT

	,@N__KAIS_CHK AS INT
	,@N__KAIS_FROM AS NVARCHAR(20)
	,@N__KAIS_TO AS NVARCHAR(20)

	,@N__KOJ_CHK AS INT
	,@N__KOJ_FROM AS NVARCHAR(20)
	,@N__KOJ_TO AS NVARCHAR(20)

	,@N__TOR_CHK AS INT
	,@N__TOR_FROM AS NVARCHAR(20)
	,@N__TOR_TO AS NVARCHAR(20)

	,@N__Eigyo_Tant_CHK AS INT
	,@N__Eigyo_Tant_FROM AS NVARCHAR(20)
	,@N__Eigyo_Tant_TO AS NVARCHAR(20)
)
AS 
SET NOCOUNT ON;
BEGIN

	SELECT KOJ.KAIS
		  ,KOJ.KAIS_NAME
		  ,KOJ.BMN_UW
		  ,KOJ.BMN_UW_NAME
		  ,KOJ.SEIK
		  ,KOJ.SEIK_RYAKU
		  ,KOJ.SEIK_KANA
		  ,KOJ.SEIK_NAME
		  ,KOJ.SEIK_NAME2
		  ,KOJ.KAISYU_KBN
		  ,KOJ.SIME_HACH
		  ,KOJ.KAISYU
		  ,KOJ.KAISYU_KIN_RITU
		  ,KOJ.KAISYU_TEG_RITU
		  ,KOJ.KAISYU_TEG_SAIT
		  ,KOJ.HORYU_RITU
		  ,KOJ.KOJ
		  ,KOJ.KOJ_NAME
		  ,KOJ.HACH
		  ,KOJ.HACH_NAME
		  ,KOJ.KOUHOU
		  ,KOJ.KOUHOU_NAME
		  ,KOJ.EIGYO_TANT_NAME 
		  ,KOJ.KOJ_TANT_NAME 
		  ,SUB.SEIK_KIN 
		  ,SUB.SEIK_ZEI 
		  ,KOJ.SYUNKO 
		  ,KOJ.KAN_FURI 
		  ,KOJ.KEIY_KIN 
		  ,KOJ.ZEI_KIN 
		  ,SUB.SEIK_KIN 
		  ,SUB.T_SEI_KIN 
		  ,SUB.N1MSEIK_KIN 
		  ,SUB.N1MSEIK_ZEI 
		  ,SUB.NRSEIK_KIN 
		  ,SUB.NR1SEIK_KIN 
		  ,SUB.NR2SEIK_KIN 
		  ,SUB.NR3SEIK_KIN 
		  ,SUB.NR4SEIK_KIN 
		  ,SUB.NR5SEIK_KIN 
		  ,SUB.NSEIK_KIN 
		  ,SUB.N1SEIK_KIN 
		  ,SUB.N2SEIK_KIN 
		  ,SUB.N3SEIK_KIN 
		  ,SUB.N4SEIK_KIN 
		  ,SUB.N5SEIK_KIN 
		  ,SUB.NSEIK_ZEI 
		  ,SUB.N1SEIK_ZEI 
		  ,SUB.N2SEIK_ZEI 
		  ,SUB.N3SEIK_ZEI 
		  ,SUB.N4SEIK_ZEI 
		  ,SUB.N5SEIK_ZEI 
		  ,0 HANBAI_SW 
	FROM
		(SELECT 
			KOJ.KAIS KAIS
			,KAI.RYAKU   KAIS_NAME
			,KOJ.BMN_UW BMN_UW
			,BMN.RYAKU   BMN_UW_NAME
			,KOJ.SEIK SEIK
			,TOR.RYAKU SEIK_RYAKU
			,TOR.KANA  SEIK_KANA
			,TOR.NAME  SEIK_NAME
			,TOR.NAME2 SEIK_NAME2
			,TOR.KAISYU_KBN
			,TOR.SIME_HACH
			,TOR.KAISYU
			,TOR.KAISYU_KIN_RITU
			,TOR.KAISYU_TEG_RITU
			,TOR.KAISYU_TEG_SAIT
			,TOR.HORYU_RITU
			,KOJ.CODE KOJ
			,KOJ.RYAKU KOJ_NAME
			,KOJ.HACH HACH
			,TO2.RYAKU       HACH_NAME
			,KOJ.YOBI_CODE2	 KOUHOU
			,MEI.RYAKU	   KOUHOU_NAME
			,TAE.NAME	   EIGYO_TANT_NAME
			,TAK.NAME	   KOJ_TANT_NAME
			,KOJ.SYUNKO
			,KOJ.KAN_FURI
			,KOJ.KEIY_KIN + KOJ.KEIY_KIN_HEN KEIY_KIN
			,KOJ.ZEI_KIN	 + KOJ.ZEI_KIN_HEN  ZEI_KIN
			FROM M_KOJ KOJ 
			LEFT JOIN V_HACH TOR
				ON KOJ.SEIK = TOR.CODE
			LEFT JOIN M_MEI MEI
				ON KOJ.YOBI_CODE2 = MEI.CODE
					AND MEI.MKBN = 32076000
			LEFT JOIN M_KAIS KAI
				ON KOJ.KAIS = KAI.CODE
			LEFT JOIN M_BMN_UW BMN
				ON KOJ.BMN_UW = BMN.CODE
			LEFT JOIN M_TANT TAE
				ON KOJ.EIGYO_TANT = TAE.CODE
			LEFT JOIN M_TANT TAK
				ON KOJ.KOJ_TANT = TAK.CODE
			LEFT JOIN M_TOR TO2
				ON KOJ.HACH = TO2.CODE
			WHERE KOJ.CODE <> KOJ.BMN_UW
			AND KOJ.BMN_UW IN (
									SELECT BMN_UW FROM W_BMN
									WHERE @N__USER_NO = USER_NO
										  AND @C__SESSION_ID = SESSION_ID
										  AND @N__PROGRAM_CODE = PROGRAM_CODE
							  )
			AND KOJ.NYU_KANRI_KBN = 0
			AND
			(
				@N__KAIS_CHK = 0
				OR
				(
					@N__KAIS_CHK = 1
					AND KOJ.KAIS BETWEEN @N__KAIS_FROM AND @N__KAIS_TO 
				)
			)
			AND
			(
				@N__KOJ_CHK = 0
				OR
				(
					@N__KOJ_CHK = 1
					AND KOJ.CODE BETWEEN @N__KOJ_FROM AND @N__KOJ_TO 
				)
			)
			AND
			(
				@N__TOR_CHK = 0
				OR
				(
					@N__TOR_CHK = 1
					AND KOJ.SEIK BETWEEN @N__TOR_FROM AND @N__TOR_TO 
				)
			)
			AND
			(
				@N__Eigyo_Tant_CHK = 0
				OR
				(
					@N__Eigyo_Tant_CHK = 1
					AND KOJ.EIGYO_TANT BETWEEN @N__Eigyo_Tant_FROM AND @N__Eigyo_Tant_TO 
				)
			)
		) KOJ
	LEFT JOIN 
		(SELECT SEK.KAIS
				,SEK.KOJ
				,SUM(NVL(SEK.KIN,0)) SEIK_KIN
				,SUM(NVL(SEK.U_ZEI,0)) SEIK_ZEI
				,1 T_SEI_KIN
				,1 N1MSEIK_KIN
				,1 N1MSEIK_ZEI
				,1 NRSEIK_KIN
				,1 NR1SEIK_KIN
				,1 NR2SEIK_KIN
				,1 NR3SEIK_KIN
				,1 NR4SEIK_KIN
				,1 NR5SEIK_KIN
				,1 NSEIK_KIN
				,1 N1SEIK_KIN
				,1 N2SEIK_KIN
				,1 N3SEIK_KIN
				,1 N4SEIK_KIN
				,1 N5SEIK_KIN
				,1 NSEIK_ZEI
				,1 N1SEIK_ZEI
				,1 N2SEIK_ZEI
				,1 N3SEIK_ZEI
				,1 N4SEIK_ZEI
				,1 N5SEIK_ZEI

		FROM D_SEIK      SEK
		GROUP BY 
			SEK.KAIS
			,SEK.KOJ
		) SUB
	ON KOJ.KAIS = SUB.KAIS
		AND KOJ.KOJ = SUB.KOJ


END;
